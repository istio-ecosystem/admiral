
#This should be installed in the cluster with the istio deployment


#read access to all namespace
---

kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admiral-sync-read
rules:
- apiGroups: ['', 'apps']
  resources: [ 'pods', 'services', 'nodes', 'deployments']
  verbs: ['get', 'watch', 'list']
- apiGroups: ["networking.istio.io"]
  resources: ['virtualservices', 'destinationrules', 'serviceentries', 'envoyfilters' ,'gateways', 'sidecars']
  verbs: [ "get", "list", "watch"]
- apiGroups: ["admiral.io"]
  resources: ['globaltrafficpolicies']
  verbs: [ "get", "list", "watch"]
---

#only write istio networking to admiral-sync namespace
---

kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admiral-sync-write
  namespace: admiral-sync
rules:
  - apiGroups: ["networking.istio.io"]
    resources: ['virtualservices', 'destinationrules', 'serviceentries', 'gateways']
    verbs: ["create", "update"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: admiral-sync-write-binding
  namespace: admiral-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: admiral-sync-write
subjects:
  - kind: ServiceAccount
    name: admiral
    namespace: admiral-sync

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admiral-sync-read-binding
  namespace: admiral-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admiral-sync-read
subjects:
  - kind: ServiceAccount
    name: admiral
    namespace: admiral-sync

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: admiral
  namespace: admiral-sync
